<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>{{ .Title }}</title>
    <!-- Include PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        // Set worker path
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>
    <style>
        :root {
            --primary-color: #005890;
            --secondary-color: #444;
            --background-color: #404040;
            --page-background: #ffffff;
            --control-bg: #ffffff;
            --border-color: #ddd;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--background-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        
        #viewer-container {
            width: 100%;
            height: 100%;
            overflow: auto;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
        }
        
        #pdf-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--control-bg);
            color: var(--secondary-color);
            padding: 8px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .control-group {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        
        #pdf-controls button {
            margin: 0 5px;
            padding: 6px 12px;
            cursor: pointer;
            background: white;
            border: 1px solid var(--border-color);
            color: var(--secondary-color);
            border-radius: 3px;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        #pdf-controls button:hover {
            background: #f0f0f0;
        }
        
        #pdf-controls button.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        #page-info {
            margin: 0 10px;
            white-space: nowrap;
            font-size: 14px;
        }
        
        #pdf-viewer {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 0;
            transition: margin-left 0.3s ease;
            background-color: var(--background-color);
        }
        
        #thumbnails-sidebar {
            position: fixed;
            left: -200px;
            top: 0;
            width: 200px;
            height: 100%;
            background: #333;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 2px 0 5px rgba(0,0,0,0.3);
            transition: left 0.3s ease;
            padding-top: 50px;
            color: #fff;
        }
        
        #thumbnails-sidebar.open {
            left: 0;
        }
        
        #pdf-viewer.with-sidebar {
            margin-left: 200px;
        }
        
        .thumbnail-item {
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        
        .thumbnail-item.active {
            background-color: rgba(255,255,255,0.1);
        }
        
        .thumbnail-item img {
            max-width: 80%;
            height: auto;
            border: 1px solid #555;
        }
        
        .thumbnail-item .page-num {
            display: block;
            font-size: 12px;
            margin-top: 5px;
            color: #ddd;
        }
        
        .pdf-page {
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.4);
            width: 100%;
            display: flex;
            justify-content: center;
            background: var(--page-background);
            max-width: 800px;
            border-radius: 2px;
        }
        
        #download-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 5px;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-size: 14px;
        }
        
        #download-link:hover {
            background: #004370;
        }
        
        /* Dual page layout */
        .dual-page-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 1620px;
            margin-bottom: 20px;
        }
        
        .dual-page-container .pdf-page {
            margin: 0;
            width: auto;
            flex: 1;
            max-width: 800px;
        }
        
        /* Search bar */
        #search-container {
            margin: 0 10px;
            display: flex;
            align-items: center;
        }
        
        #search-input {
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: 14px;
            width: 150px;
        }
        
        #search-prev, #search-next {
            padding: 6px 8px;
            cursor: pointer;
        }
        
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .pdf-page {
                width: 95%;
                display: flex;
                justify-content: center;
                padding: 0;
                box-sizing: border-box;
                max-width: none;
            }
            
            .pdf-page canvas {
                width: 100% !important;
                height: auto !important;
                object-fit: contain;
            }
            
            #pdf-controls {
                padding: 5px;
                flex-wrap: wrap;
                justify-content: space-around;
            }
            
            .control-group {
                margin: 5px 0;
            }
            
            #page-info {
                order: -1;
                width: 100%;
                text-align: center;
                margin-bottom: 5px;
            }
            
            #thumbnails-sidebar {
                width: 150px;
            }
            
            #pdf-viewer.with-sidebar {
                margin-left: 150px;
            }
            
            #search-container {
                width: 100%;
                margin: 5px 0;
            }
            
            #search-input {
                width: 100%;
            }
            
            .dual-page-container {
                flex-direction: column;
                max-width: none;
            }
            
            /* Hide some controls on mobile */
            #view-mode-btn, #search-container {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="viewer-container">
        <div id="pdf-controls">
            <div class="control-group">
                <button id="prev-page">Previous</button>
                <span id="page-info">Page <span id="page-num">1</span> of <span id="page-count">1</span></span>
                <button id="next-page">Next</button>
            </div>
            
            <div class="control-group">
                <button id="zoom-out">-</button>
                <button id="zoom-in">+</button>
                <button id="view-mode-btn">Two Pages</button>
                <button id="thumbnails-btn">Thumbnails</button>
            </div>
            
            <div id="search-container">
                <input type="text" id="search-input" placeholder="Search...">
                <button id="search-prev">◀</button>
                <button id="search-next">▶</button>
            </div>
        </div>
        
        <div id="thumbnails-sidebar"></div>
        <div id="pdf-viewer"></div>
    </div>
    
    <a id="download-link" href="{{ .Params.pdf }}" download>Download PDF</a>

    <script>
        // PDF viewing settings
        let pdfDoc = null,
            pageNum = 1,
            pageRendering = false,
            pageNumPending = null,
            scale = 1.0,
            pagesRendered = new Set(),
            viewMode = 'single', // 'single' or 'double'
            sidebarOpen = false,
            currentSearchIndex = -1,
            searchResults = [],
            renderQueue = [];
        
        const container = document.getElementById('pdf-viewer');
        const sidebar = document.getElementById('thumbnails-sidebar');
        const prevButton = document.getElementById('prev-page');
        const nextButton = document.getElementById('next-page');
        const pageNumDisplay = document.getElementById('page-num');
        const pageCountDisplay = document.getElementById('page-count');
        const zoomInButton = document.getElementById('zoom-in');
        const zoomOutButton = document.getElementById('zoom-out');
        const viewModeButton = document.getElementById('view-mode-btn');
        const thumbnailsButton = document.getElementById('thumbnails-btn');
        const searchInput = document.getElementById('search-input');
        const searchPrevButton = document.getElementById('search-prev');
        const searchNextButton = document.getElementById('search-next');

        // Detect if we're on mobile
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            viewMode = 'single'; // Force single page view on mobile
            scale = 1.0;
        }

        // Load the PDF
        pdfjsLib.getDocument('{{ .Params.pdf }}').promise.then(function(pdf) {
            pdfDoc = pdf;
            pageCountDisplay.textContent = pdf.numPages;
            
            // Generate thumbnails
            generateThumbnails(pdf);
            
            // Initial render
            if (viewMode === 'single') {
                renderPage(1);
            } else {
                renderDualPage(1);
            }
            
            // Enable search if not on mobile
            if (!isMobile) {
                setupSearch();
            }
            
        }).catch(function(error) {
            console.error('Error loading PDF:', error);
            container.innerHTML = '<p style="color: var(--secondary-color); text-align: center; margin-top: 50px;">Failed to load PDF. Please try downloading it instead.</p>';
        });

        // Generate thumbnails for sidebar
        function generateThumbnails(pdf) {
            const fragment = document.createDocumentFragment();
            
            // Create thumbnails for each page
            const renderThumbnail = function(pageNum) {
                pdf.getPage(pageNum).then(function(page) {
                    const viewport = page.getViewport({ scale: 0.2 });
                    
                    const thumbnailItem = document.createElement('div');
                    thumbnailItem.className = 'thumbnail-item';
                    thumbnailItem.dataset.page = pageNum;
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    thumbnailItem.appendChild(canvas);
                    
                    const pageNumSpan = document.createElement('span');
                    pageNumSpan.className = 'page-num';
                    pageNumSpan.textContent = 'Page ' + pageNum;
                    thumbnailItem.appendChild(pageNumSpan);
                    
                    // Render the thumbnail
                    page.render({
                        canvasContext: context,
                        viewport: viewport
                    });
                    
                    // Add click event
                    thumbnailItem.addEventListener('click', function() {
                        const clickedPage = parseInt(this.dataset.page);
                        if (clickedPage !== pageNum) {
                            pageNum = clickedPage;
                            container.innerHTML = '';
                            pagesRendered.clear();
                            
                            if (viewMode === 'single') {
                                renderPage(pageNum);
                            } else {
                                renderDualPage(pageNum);
                            }
                            
                            updateUI();
                            
                            // Highlight the active thumbnail
                            document.querySelectorAll('.thumbnail-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            this.classList.add('active');
                        }
                        
                        // On mobile, close sidebar after selection
                        if (isMobile) {
                            toggleSidebar();
                        }
                    });
                    
                    fragment.appendChild(thumbnailItem);
                    
                    // If this is page 1, mark it as active
                    if (pageNum === 1) {
                        thumbnailItem.classList.add('active');
                    }
                });
            };
            
            // Generate first 5 thumbnails immediately, then the rest
            for (let i = 1; i <= Math.min(5, pdf.numPages); i++) {
                renderThumbnail(i);
            }
            
            setTimeout(() => {
                for (let i = 6; i <= pdf.numPages; i++) {
                    renderThumbnail(i);
                }
                sidebar.appendChild(fragment);
            }, 500);
        }

        // Setup search functionality
        function setupSearch() {
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter' && this.value.trim().length > 0) {
                    performSearch(this.value.trim());
                }
            });
            
            searchNextButton.addEventListener('click', function() {
                navigateSearch(1);
            });
            
            searchPrevButton.addEventListener('click', function() {
                navigateSearch(-1);
            });
        }

        // Perform search across the PDF
        function performSearch(query) {
            searchResults = [];
            currentSearchIndex = -1;
            
            let pendingSearches = pdfDoc.numPages;
            
            for (let i = 1; i <= pdfDoc.numPages; i++) {
                pdfDoc.getPage(i).then(function(page) {
                    page.getTextContent().then(function(textContent) {
                        const text = textContent.items.map(item => item.str).join(' ');
                        
                        if (text.toLowerCase().includes(query.toLowerCase())) {
                            searchResults.push(i);
                        }
                        
                        pendingSearches--;
                        
                        if (pendingSearches === 0 && searchResults.length > 0) {
                            // Navigate to first result
                            navigateSearch(1);
                        }
                    });
                });
            }
        }

        // Navigate through search results
        function navigateSearch(direction) {
            if (searchResults.length === 0) return;
            
            if (direction > 0) {
                currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
            } else {
                currentSearchIndex = (currentSearchIndex - 1 + searchResults.length) % searchResults.length;
            }
            
            const targetPage = searchResults[currentSearchIndex];
            pageNum = targetPage;
            
            // Clear and re-render
            container.innerHTML = '';
            pagesRendered.clear();
            
            if (viewMode === 'single') {
                renderPage(pageNum);
            } else {
                renderDualPage(pageNum);
            }
            
            updateUI();
            
            // Update sidebar
            document.querySelectorAll('.thumbnail-item').forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.dataset.page) === pageNum) {
                    item.classList.add('active');
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        }

        // Toggle sidebar
        function toggleSidebar() {
            sidebarOpen = !sidebarOpen;
            if (sidebarOpen) {
                sidebar.classList.add('open');
                if (!isMobile) {
                    container.classList.add('with-sidebar');
                }
                thumbnailsButton.classList.add('active');
            } else {
                sidebar.classList.remove('open');
                container.classList.remove('with-sidebar');
                thumbnailsButton.classList.remove('active');
            }
        }

        // Render a specific page (single page mode)
        function renderPage(num) {
            if (pagesRendered.has(num)) return;
            
            pageRendering = true;
            
            // Create a div for this page
            const pageDiv = document.createElement('div');
            pageDiv.className = 'pdf-page';
            pageDiv.id = `page-${num}`;
            container.appendChild(pageDiv);
            
            // Get the page
            pdfDoc.getPage(num).then(function(page) {
                // Account for device pixel ratio for sharper rendering
                const pixelRatio = window.devicePixelRatio || 1;
                
                const containerWidth = isMobile ? 
                    container.clientWidth * 0.95 : // 95% width on mobile
                    Math.min(800, container.clientWidth - 60); // Limit max width on desktop
                
                // Calculate viewport with appropriate scale
                const viewport = page.getViewport({ scale: 1.0 }); // Start with scale 1
                const scaleNeeded = containerWidth / viewport.width;
                const finalScale = scaleNeeded * scale; // Adjust for user zoom
                const scaledViewport = page.getViewport({ scale: finalScale });
                
                // Create a canvas for this page
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d', { alpha: false });
                
                // Set canvas dimensions accounting for pixel ratio for crisp rendering
                canvas.height = scaledViewport.height * pixelRatio;
                canvas.width = scaledViewport.width * pixelRatio;
                
                // Scale down the canvas display size to match the viewport
                canvas.style.height = `${scaledViewport.height}px`;
                canvas.style.width = `${scaledViewport.width}px`;
                
                // Scale up the context to account for pixel ratio
                context.scale(pixelRatio, pixelRatio);
                
                // Set background for the canvas
                context.fillStyle = 'white';
                context.fillRect(0, 0, canvas.width, canvas.height);
                
                pageDiv.appendChild(canvas);
                
                // Render the page with high quality settings
                const renderContext = {
                    canvasContext: context,
                    viewport: scaledViewport,
                    background: 'white',
                    enableWebGL: true,
                    renderInteractiveForms: true
                };
                
                page.render(renderContext).promise.then(function() {
                    pageRendering = false;
                    pagesRendered.add(num);
                    
                    // If we're scrolling down, ensure more pages are loaded
                    if (num === pageNum) {
                        // Check if we need to render more pages
                        if (container.scrollTop + container.clientHeight > pageDiv.offsetTop + pageDiv.offsetHeight/2) {
                            if (num < pdfDoc.numPages) {
                                renderPage(num + 1);
                            }
                        }
                    }
                });
            });
        }

        // Render two pages side by side (dual page mode)
        function renderDualPage(startPage) {
            // Create a container for the dual pages
            const dualContainer = document.createElement('div');
            dualContainer.className = 'dual-page-container';
            dualContainer.id = `dual-${startPage}`;
            container.appendChild(dualContainer);
            
            // Render left page
            const leftPage = document.createElement('div');
            leftPage.className = 'pdf-page';
            leftPage.id = `page-${startPage}`;
            dualContainer.appendChild(leftPage);
            
            pdfDoc.getPage(startPage).then(function(page) {
                // Account for device pixel ratio for sharper rendering
                const pixelRatio = window.devicePixelRatio || 1;
                
                const maxWidth = container.clientWidth - 40;
                const containerWidth = isMobile ? 
                    (maxWidth * 0.95) : 
                    Math.min(800, (maxWidth - 10) / 2); // Account for gap
                
                const viewport = page.getViewport({ scale: 1.0 });
                const scaleNeeded = containerWidth / viewport.width;
                const finalScale = scaleNeeded * scale;
                const scaledViewport = page.getViewport({ scale: finalScale });
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d', { alpha: false });
                
                // Set canvas dimensions accounting for pixel ratio for crisp rendering
                canvas.height = scaledViewport.height * pixelRatio;
                canvas.width = scaledViewport.width * pixelRatio;
                
                // Scale down the canvas display size to match the viewport
                canvas.style.height = `${scaledViewport.height}px`;
                canvas.style.width = `${scaledViewport.width}px`;
                
                // Scale up the context to account for pixel ratio
                context.scale(pixelRatio, pixelRatio);
                
                // Set background for the canvas
                context.fillStyle = 'white';
                context.fillRect(0, 0, canvas.width, canvas.height);
                
                leftPage.appendChild(canvas);
                
                // Render the page with high quality settings
                page.render({
                    canvasContext: context,
                    viewport: scaledViewport,
                    background: 'white',
                    enableWebGL: true,
                    renderInteractiveForms: true
                }).promise.then(function() {
                    pagesRendered.add(startPage);
                });
            });
            
            // Render right page (if not last page)
            if (startPage < pdfDoc.numPages) {
                const rightPage = document.createElement('div');
                rightPage.className = 'pdf-page';
                rightPage.id = `page-${startPage + 1}`;
                dualContainer.appendChild(rightPage);
                
                pdfDoc.getPage(startPage + 1).then(function(page) {
                    // Account for device pixel ratio for sharper rendering
                    const pixelRatio = window.devicePixelRatio || 1;
                    
                    const maxWidth = container.clientWidth - 40;
                    const containerWidth = isMobile ? 
                        (maxWidth * 0.95) : 
                        Math.min(800, (maxWidth - 10) / 2); // Account for gap
                    
                    const viewport = page.getViewport({ scale: 1.0 });
                    const scaleNeeded = containerWidth / viewport.width;
                    const finalScale = scaleNeeded * scale;
                    const scaledViewport = page.getViewport({ scale: finalScale });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d', { alpha: false });
                    
                    // Set canvas dimensions accounting for pixel ratio for crisp rendering
                    canvas.height = scaledViewport.height * pixelRatio;
                    canvas.width = scaledViewport.width * pixelRatio;
                    
                    // Scale down the canvas display size to match the viewport
                    canvas.style.height = `${scaledViewport.height}px`;
                    canvas.style.width = `${scaledViewport.width}px`;
                    
                    // Scale up the context to account for pixel ratio
                    context.scale(pixelRatio, pixelRatio);
                    
                    // Set background for the canvas
                    context.fillStyle = 'white';
                    context.fillRect(0, 0, canvas.width, canvas.height);
                    
                    rightPage.appendChild(canvas);
                    
                    // Render the page with high quality settings
                    page.render({
                        canvasContext: context,
                        viewport: scaledViewport,
                        background: 'white',
                        enableWebGL: true,
                        renderInteractiveForms: true
                    }).promise.then(function() {
                        pagesRendered.add(startPage + 1);
                        
                        // If there are more pages to render, continue
                        if (startPage + 2 <= pdfDoc.numPages) {
                            renderDualPage(startPage + 2);
                        }
                    });
                });
            }
        }

        // Update page counters and UI
        function updateUI() {
            pageNumDisplay.textContent = pageNum;
            
            // Manage button states
            prevButton.disabled = pageNum <= 1;
            nextButton.disabled = pageNum >= pdfDoc.numPages;
            
            // In dual mode, next button should be disabled only when both pages of the last pair are shown
            if (viewMode === 'double' && pageNum === pdfDoc.numPages - 1) {
                nextButton.disabled = true;
            }
            
            // Check if we need to render the next page or pair
            if (viewMode === 'single') {
                if (!pagesRendered.has(pageNum + 1) && pageNum < pdfDoc.numPages) {
                    renderPage(pageNum + 1);
                }
            } else {
                if (!pagesRendered.has(pageNum + 2) && pageNum + 1 < pdfDoc.numPages) {
                    renderDualPage(pageNum + 2);
                }
            }
            
            // Scroll to current page or page pair
            const targetElement = viewMode === 'single' ? 
                document.getElementById(`page-${pageNum}`) : 
                document.getElementById(`dual-${pageNum}`);
            
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Toggle view mode between single and double page
        function toggleViewMode() {
            viewMode = viewMode === 'single' ? 'double' : 'single';
            viewModeButton.textContent = viewMode === 'single' ? 'Two Pages' : 'Single Page';
            viewModeButton.classList.toggle('active', viewMode === 'double');
            
            // Clear and re-render
            container.innerHTML = '';
            pagesRendered.clear();
            
            if (viewMode === 'single') {
                renderPage(pageNum);
            } else {
                // Make sure we start on an odd page for dual view
                if (pageNum % 2 === 0 && pageNum > 1) {
                    pageNum--;
                }
                renderDualPage(pageNum);
            }
            
            updateUI();
        }

        // Previous page button
        prevButton.addEventListener('click', function() {
            if (pageNum <= 1) return;
            
            if (viewMode === 'single') {
                pageNum--;
            } else {
                pageNum = Math.max(1, pageNum - 2);
            }
            
            updateUI();
        });

        // Next page button
        nextButton.addEventListener('click', function() {
            if (pageNum >= pdfDoc.numPages) return;
            
            if (viewMode === 'single') {
                pageNum++;
            } else {
                pageNum = Math.min(pdfDoc.numPages, pageNum + 2);
            }
            
            updateUI();
        });

        // Zoom in button
        zoomInButton.addEventListener('click', function() {
            scale += 0.25;
            // Clear and re-render with new scale
            container.innerHTML = '';
            pagesRendered.clear();
            
            if (viewMode === 'single') {
                renderPage(pageNum);
            } else {
                renderDualPage(pageNum);
            }
            
            updateUI();
        });

        // Zoom out button
        zoomOutButton.addEventListener('click', function() {
            if (scale <= 0.5) return;
            scale -= 0.25;
            // Clear and re-render with new scale
            container.innerHTML = '';
            pagesRendered.clear();
            
            if (viewMode === 'single') {
                renderPage(pageNum);
            } else {
                renderDualPage(pageNum);
            }
            
            updateUI();
        });

        // View mode toggle
        viewModeButton.addEventListener('click', function() {
            if (!isMobile) {
                toggleViewMode();
            }
        });

        // Thumbnails toggle
        thumbnailsButton.addEventListener('click', function() {
            toggleSidebar();
        });

        // Handle scroll to load more pages (lazy loading)
        container.addEventListener('scroll', function() {
            if (pageRendering) return;
            
            // Find which page is most visible in the viewport
            let closestPage = 1;
            let closestDistance = Infinity;
            
            if (viewMode === 'single') {
                const pages = document.querySelectorAll('.pdf-page');
                
                pages.forEach(function(page) {
                    const pageId = parseInt(page.id.split('-')[1]);
                    const rect = page.getBoundingClientRect();
                    const pageCenter = rect.top + rect.height/2;
                    const viewportCenter = container.getBoundingClientRect().top + container.clientHeight/2;
                    const distance = Math.abs(pageCenter - viewportCenter);
                    
                    if (distance < closestDistance) {
                        closestDistance = distance;
                        closestPage = pageId;
                    }
                    
                    // Check if we need to render more pages
                    if (pageId === pdfDoc.numPages) return;
                    
                    // If page is visible and next page isn't rendered, render it
                    if (rect.bottom > 0 && rect.top < container.clientHeight && !pagesRendered.has(pageId + 1)) {
                        renderPage(pageId + 1);
                    }
                });
            } else {
                // Dual page mode - detect which page pair is most visible
                const containers = document.querySelectorAll('.dual-page-container');
                
                containers.forEach(function(dualContainer) {
                    const startPage = parseInt(dualContainer.id.split('-')[1]);
                    const rect = dualContainer.getBoundingClientRect();
                    const containerCenter = rect.top + rect.height/2;
                    const viewportCenter = container.getBoundingClientRect().top + container.clientHeight/2;
                    const distance = Math.abs(containerCenter - viewportCenter);
                    
                    if (distance < closestDistance) {
                        closestDistance = distance;
                        closestPage = startPage;
                    }
                    
                    // Check if we need to render more pages
                    if (startPage + 1 >= pdfDoc.numPages) return;
                    
                    // If container is visible and next pair isn't rendered, render it
                    if (rect.bottom > 0 && rect.top < container.clientHeight && !pagesRendered.has(startPage + 2)) {
                        renderDualPage(startPage + 2);
                    }
                });
            }
            
            // Update current page if it's different
            if (closestPage !== pageNum) {
                pageNum = closestPage;
                
                // Update sidebar selection
                document.querySelectorAll('.thumbnail-item').forEach(item => {
                    item.classList.remove('active');
                    if (parseInt(item.dataset.page) === pageNum) {
                        item.classList.add('active');
                    }
                });
                
                pageNumDisplay.textContent = pageNum;
            }
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            // Re-render on any significant resize to ensure proper scaling
            const currentWidth = window.innerWidth;
            const newIsMobile = currentWidth <= 768;
            
            // Check if mobile state changed
            if (newIsMobile !== isMobile) {
                // Force single page view on mobile
                if (newIsMobile && viewMode === 'double') {
                    viewMode = 'single';
                    viewModeButton.textContent = 'Two Pages';
                    viewModeButton.classList.remove('active');
                }
            }
            
            // Clear and re-render
            container.innerHTML = '';
            pagesRendered.clear();
            
            if (viewMode === 'single') {
                renderPage(pageNum);
            } else {
                renderDualPage(pageNum);
            }
            
            updateUI();
        });
    </script>
</body>
</html>
